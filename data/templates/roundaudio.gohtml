<!DOCTYPE html>
<html>
<head>
    <style>
        :root {
            --progress: 0;
        }

        body {
            padding: 0;
            margin: 0;
        }
        .gradient-box {
            position: relative;
            width: 1024px;
            height: 1024px;
            background:
                    radial-gradient(circle, transparent 0%, black 80%),
                    url("/static/unibasel.svg") no-repeat center;
            background-size: cover, 60%; /* SVG auf 60% Größe für Dezentheit */
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1a1a1a;
            font-family: 'Courier New', Courier, monospace;
        }

        .center-info {
            position: absolute;
            text-align: center;
            z-index: 10;
            /* Optional: Ein leichter Schatten macht den Text auf dem Gradienten lesbarer */
            /* text-shadow: 0 0 10px rgba(0,0,0,0.5); */
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.1);
        }
        .time-display {
            font-size: 60px;
            font-weight: 800; /* Dickere Schrift wirkt bei dunklen Farben oft besser */
            letter-spacing: 3px;
            margin-bottom: 5px;
        }

        .track-info {
            font-size: 18px;
            letter-spacing: 8px;
            opacity: 0.9;
            /* Eine dunkle Trennlinie */
            border-top: 2px solid #1a1a1a;
            padding-top: 15px;
            margin-top: 10px;
        }

        .progress-svg {
            transform: rotate(-90deg) scaleY(-1);
            width: 900px;
            height: 900px;
        }

        .progress-background {
            fill: none;
            stroke: rgba(255, 255, 255, 0.05);
            stroke-width: 25;
        }

        .progress-bar {
            fill: none;
            stroke: #A5D7D2;
            stroke-width: 50;
            stroke-linecap: butt;
            stroke-dasharray: 2513;

            stroke-dashoffset: calc(2513 - (2513 * var(--progress)) / 100);
            transition: stroke-dashoffset 0.5s ease;

            /* Hier wird der Unschärfe-Filter zugewiesen */
            filter: url(#blur-filter);
        }
    </style>
</head>
<head>
    <meta charset="utf-8">
    <script>
        let timedisplay;
        let infodisplay;
        window.addEventListener("load", function(evt) {
            timedisplay = document.getElementById("time")
            infodisplay = document.getElementById("info")
        });

        function formatDuration(seconds) {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);

            const paddedSecs = secs.toString().padStart(2, '0');

            if (hrs > 0) {
                // Wenn Stunden vorhanden sind, werden auch Minuten zweistellig formatiert
                const paddedMins = mins.toString().padStart(2, '0');
                return `${hrs}:${paddedMins}:${paddedSecs}`;
            } else {
                // Nur Minuten und Sekunden
                return `${mins}:${paddedSecs}`;
            }
        }

        let audio = null
        let currtime = 0
        let status = ""
        let doPlay = true

        function logStatus() {
            if ( audio == null ) {
                console.log("no audio")
                return
            }
            console.log({
                currentTime: audio.currentTime,
                duration: audio.duration,
                muted: audio.muted,
                volume: audio.volume,
                paused: audio.paused,
                systemTime: (new Date()).getTime(),
                status: status,
            })
        }

        function getStatus() {
            if (audio == null) return null;
            return JSON.stringify({
                currentTime: audio.currentTime,
                duration: audio.duration,
                muted: audio.muted,
                volume: audio.volume,
                paused: audio.paused,
                systemTime: (new Date()).getTime(),
                status: status,
            })
        }

        function event(evtJSON) {
            evt = JSON.parse(evtJSON)
            console.log(evt)
            dataObject = JSON.parse(evt.data)
            switch (evt.type) {
                case "load":
                    console.log( "loading " + dataObject )
                    if (audio != null ) {
                        audio.pause()
                        audio = null;
                        timedisplay.textContent = "";
                        infodisplay.textContent = "";
                        document.documentElement.style.setProperty('--progress', 0)
                    }
                    doPlay = true
                    audio = new Audio(dataObject)
                    audio.autoplay = false
                    audio.load()
                    audio.addEventListener("loadeddata", () => {
                        let duration = formatDuration(audio.duration);
                        console.log("duration: " + duration)
                        // The duration variable now holds the duration (in seconds) of the audio clip
                    });
                    audio.addEventListener("canplaythrough", (event) => {
                        /* the audio is now playable; play it if permissions allow */
                        if (doPlay) {
                            audio.play();
                            audio.muted = false;
                            doPlay = false;
                        }
                    });
                    audio.addEventListener("timeupdate", (event) => {
                        percent = 100*audio.currentTime/audio.duration
                        document.documentElement.style.setProperty('--progress', percent)
                        if ( !isNaN(audio.duration) ) timedisplay.textContent = formatDuration(audio.currentTime) + "/" + formatDuration(audio.duration)
                        if (Math.floor(audio.currentTime) > currtime ) {
                            currtime = Math.floor(audio.currentTime)
                            logStatus()
                        }
                    });
                    audio.addEventListener("ended", (event) => {
                        console.log("event: ended")
                        status = "ended"
                        logStatus()
                    })
                    audio.addEventListener("play", (event) => {
                        console.log("event: play")
                        status = "play"
                        logStatus()
                    })
                    audio.addEventListener("seeked", (event) => {
                        console.log("event: seeked")
                        status = "seeked"
                        logStatus()
                    })
                    break;
                case "play":
                    console.log("play")
                    audio.play()
                    logStatus()
                    break;
                case "pause":
                    console.log("pause")
                    audio.pause()
                    logStatus()
                    break;
                case "stop":
                    console.log("stop")
                    audio.pause()
                    audio.currentTime = 0
                    currtime = 0
                    logStatus()
                    break;
                case "unload":
                    console.log("unload")
                    if (audio == null) {
                        console.log( "no audio")
                        break
                    }
                    audio.pause()
                    audio = null;
                    timedisplay.textContent = "";
                    infodisplay.textContent = "";
                    document.documentElement.style.setProperty('--progress', 0)
                    logStatus()
                    break;
            }
        }
    </script>
</head>
<body>
<div class="gradient-box">
    <div class="center-info">
        <div id="time" class="time-display"></div>
        <div id="info" class="track-info"></div>
    </div>
    <svg class="progress-svg" viewBox="0 0 1000 1000">
        <defs>
            <!-- Definition des Unschärfe-Filters -->
            <filter id="blur-filter" x="-20%" y="-20%" width="140%" height="140%">
                <feGaussianBlur in="SourceGraphic" stdDeviation="8" />
            </filter>
        </defs>
        <!--
        <circle class="progress-background" cx="500" cy="500" r="400"></circle>
        -->
        <circle class="progress-bar" cx="500" cy="500" r="400"></circle>
    </svg>
</div>
</body>
</html>
